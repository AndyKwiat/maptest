<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OpenStreetMap Viewer</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
  </head>
  <body>
    <div id="map" style="width: 800px; height: 800px"></div>

    <script>
      function getDataInBoundingBox(bbox) {
        // const url = `https://overpass-api.de/api/interpreter?data=[out:json];nwr(${bbox});out;`;
        const url = `https://overpass-api.de/api/interpreter?data=[out:json];(way["highway"](${bbox});>;);out;`;

        return fetch(url)
          .then((response) => {
            console.log(response);
            return response.json();
          })

          .then((data) => {
            console.log(data);
            // filter out all nodes
            let returnData = {};
            returnData.nodes = data.elements.filter(
              (element) => element.type === "node"
            );
            // filter out all ways
            returnData.ways = data.elements.filter(
              (element) => element.type === "way"
            );
            // filter out all relations
            returnData.relations = data.elements.filter(
              (element) => element.type === "relation"
            );

            return returnData;
          });
      }
      const map = L.map("map").setView(
        [43.53255820104378, -80.23672699928285],
        17
      );

      const tiles = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }
      ).addTo(map);

      //   const marker = L.marker([51.5, -0.09])
      //     .addTo(map)
      //     .bindPopup("<b>Hello world!</b><br />I am a popup.")
      //     .openPopup();

      //   const circle = L.circle([51.508, -0.11], {
      //     color: "red",
      //     fillColor: "#f03",
      //     fillOpacity: 0.5,
      //     radius: 500,
      //   })
      //     .addTo(map)
      //     .bindPopup("I am a circle.");

      //   const polygon = L.polygon([
      //     [51.509, -0.08],
      //     [51.503, -0.06],
      //     [51.51, -0.047],
      //   ])
      //     .addTo(map)
      //     .bindPopup("I am a polygon.");

      const popup = L.popup();
      let allCoords = [];
      function onMapClick(e) {
        popup
          .setLatLng(e.latlng)
          .setContent(`You clicked the map at ${e.latlng.toString()}`)
          .openOn(map);
        // // find closes coord and display tags
        // const closestCoord = allCoords.reduce((prev, curr) => {
        //   const prevDist = Math.sqrt(
        //     Math.pow(prev.lat - e.latlng.lat, 2) +
        //       Math.pow(prev.lon - e.latlng.lng, 2)
        //   );
        //   const currDist = Math.sqrt(
        //     Math.pow(curr.lat - e.latlng.lat, 2) +
        //       Math.pow(curr.lon - e.latlng.lng, 2)
        //   );
        //   return prevDist < currDist ? prev : curr;
        // });
        // console.log(closestCoord);
        // let tags = closestCoord.tags;
        // // display popup with tags
        // popup
        //   .setLatLng(e.latlng)
        //   .setContent(`Tags: ${JSON.stringify(tags)}`)
        //   .openOn(map);
      }

      map.on("click", onMapClick);
      const bbox = [
        [43.533523, -80.235332],
        [43.531111, -80.240074],
      ];

      //   43.533523, -80.240074
      //   43.531111, -80.235332
      // sort bbox coordinates by latitude
      bbox.sort((a, b) => a[0] - b[0]);

      // draw bbox using leaflet
      L.rectangle(bbox, { color: "#ff7800", weight: 1 }).addTo(map);
      getDataInBoundingBox(bbox)
        .then((data) => {
          data.nodes.forEach((coord) => {
            L.circle([coord.lat, coord.lon], {
              color: "#ff7800",
              weight: 1,
              radius: 5,
            }).addTo(map);
          });
          // draw each "way"
          data.ways.forEach((way) => {
            // get all coords for this way
            let coords = way.nodes.map((node) => {
              const coord = data.nodes.find((coord) => coord.id === node);
              if (!coord) {
                //   console.log(`Could not find coord for node ${node}`);
                return [null, null];
              }
              return [coord.lat, coord.lon];
            });
            // filter out all coords with null values
            coords = coords.filter((coord) => coord[0] !== null);

            // draw the way
            if (coords.length == 2 && way.tags.highway) {
              L.polyline(coords, { color: "#00ff00", weight: 1 }).addTo(map);

              console.log(way.tags);
            }
          });
        })
        .catch((error) => console.error(error));
    </script>
  </body>
</html>
